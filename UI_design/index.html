<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to Markdown Converter with RAG</title>
    <link rel="stylesheet" href="http://localhost:5000/style.css"></link>
    <link rel="icon" href="./logo.ico" type="image/x-icon">
</head>
<body>
<div class="container">
    <div class="left-column">
        <div class="folder-management">
            <h3>Folder Management</h3>
            <p>Select or change the folder where videos are stored:</p>
            <button id="create-folder">Create Folder</button>
            <p id="selected-folder-path"></p>
            <h4>Folders:</h4>
            <ul id="folder-list"></ul>
        </div>
    </div>
    <div class="right-column">
        <h1>Video to Markdown Converter with RAG</h1>
        <div class="upload-area" id="video-upload-area">
            <label for="video-upload">Upload Video</label>
            <input type="file" id="video-upload" accept="video/*">
        </div>
        <div class="progress-bar" id ="progress-bar">
            <div class="progress-bar-fill"></div>
        </div>
        <div class="content-display">
            <div id="markdown-output" class="markdown-output"></div>
        </div>
        <div class="knowledge-points-section">
            <div class="input-section">
                <textarea id="knowledge-points-input" placeholder="Ask something..."></textarea>
                <button id="ask-button">Ask</button>
            </div>
            <div class="output-section">
                <ul class="knowledge-points" id="knowledge-points-list"></ul>
            </div>
        </div>
        <button class="save-button" id="save-md">Save Markdown File</button>
        <button class="return-button" id="return-button" style="display: none;">Return to Upload Video</button>
    </div>
</div>
<script src="http://localhost:5000/marked.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // å…¨å±€å˜é‡
    let currentFolder = '';
    let currentFiles = [];
    let currentFileIndex = 0;
    let folderSelected = false; 
    // åŠ è½½config.jsonæ–‡ä»¶
    fetch('/configs/config.json')
        .then(response => response.json())
        .then(config => {
            const filePaths = config.file_path;
            function updateProgressBar(value) {
                document.querySelector('.progress-bar-fill').style.width = value + '%';
            }
            updateFolderList();
            // ç»Ÿä¸€çš„è§†é¢‘ä¸Šä¼ å¤„ç†é€»è¾‘
            document.getElementById('video-upload').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    try {
                        console.log("æ­£åœ¨åˆå§‹åŒ–")
                        pywebview.api.initialize(filePaths);
                        console.log("åˆå§‹åŒ–å®Œæˆ")
                        // æ˜¾ç¤ºè¿›åº¦æ¡å¹¶éšè—å†…å®¹åŒºåŸŸå’Œè¿”å›æŒ‰é’®
                        document.querySelector('.content-display').style.display = 'block';
                        document.getElementById('markdown-output').innerHTML = '<div class="loading-animation">æ­£åœ¨ç”Ÿæˆmarkdownæ–‡ä»¶...â³</div>';
                        document.querySelector('.knowledge-points-section').style.display = 'none';
                        document.getElementById('return-button').style.display = 'none';

                        // ä¸Šä¼ è§†é¢‘åˆ°åç«¯
                        const formData = new FormData();
                        formData.append('video', file);

                        const uploadResponse = await fetch('/api/upload-video', {
                            method: 'POST',
                            body: formData,
                        });

                        const uploadData = await uploadResponse.json();
                        if (uploadData.message === 'Video uploaded and renamed successfully.') {
                            console.log('è§†é¢‘ä¸Šä¼ æˆåŠŸï¼Œå¼€å§‹å¤„ç†è§†é¢‘...');

                            updateProgressBar(10);
                            await pywebview.api.remove_same_frames(filePaths.video_path, filePaths.video_after_path);
                            updateProgressBar(30);
                            
                            await generate_transcript();
                            updateProgressBar(60);

                            await export_images();
                            updateProgressBar(70);
                            
                            await export_main_md();
                            updateProgressBar(90);
                            
                            await display_md();
                            updateProgressBar(100);
                            // æ˜¾ç¤ºå†…å®¹åŒºåŸŸå’Œè¿”å›æŒ‰é’®
                            document.querySelector('.content-display').style.display = 'block';
                            document.querySelector('.knowledge-points-section').style.display = 'block';
                            document.getElementById('return-button').style.display = 'block';
                            document.getElementById('video-upload-area').style.display = 'none';
                            document.getElementById('progress-bar').style.display = 'none';
                            document.getElementById('save-md').style.display = 'block';
                        }
                    } catch (error) {
                        console.error('è§†é¢‘ä¸Šä¼ å’Œå¤„ç†æ—¶å‡ºé”™:', error);
                        updateProgressBar(0);
                    }
                }
            });

            // ç”Ÿæˆè½¬å½•
            async function generate_transcript() {
                try {
                    await pywebview.api.generate_transcript(filePaths.video_path, filePaths.audio_path, filePaths.transcript_path);
                    console.log('è½¬å½•å®Œæˆ');
                } catch (err) {
                    console.error('ç”Ÿæˆè½¬å½•æ—¶å‡ºé”™:', err);
                    throw err; // å‘ä¸Šä¼ æµç¨‹æŠ›å‡ºé”™è¯¯
                }
            }

            // å¯¼å‡ºå›¾ç‰‡
            async function export_images() {
                try {
                    await pywebview.api.export_images();
                    console.log('å›¾ç‰‡å¯¼å‡ºå®Œæˆ');
                } catch (err) {
                    console.error('å¯¼å‡ºå›¾ç‰‡æ—¶å‡ºé”™:', err);
                    throw err;
                }
            }

            // å¯¼å‡ºMarkdown
            async function export_main_md() {
                try {
                    await pywebview.api.export_main_md(filePaths.filter_images_path, filePaths.transcript_path, filePaths.output_path);
                    console.log('Markdownå¯¼å‡ºå®Œæˆ');
                } catch (err) {
                    console.error('å¯¼å‡ºMarkdownæ—¶å‡ºé”™:', err);
                    throw err;
                }
            }

            // ç”Ÿæˆæ—¶æ˜¾ç¤ºMarkdown
            async function display_md() {
                try {
                    const markdownFiles = await pywebview.api.read_md_files(filePaths.output_path);
                    const firstMdFile = Object.values(markdownFiles)[0];
                    const htmlContent = marked(firstMdFile);
                    // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå†…å®¹
                    document.getElementById('markdown-output').innerHTML = htmlContent;
                } catch (err) {
                    console.error('è¯»å–å¹¶æ˜¾ç¤º_MD_æ–‡ä»¶æ—¶å‡ºé”™:', err);
                    throw err;
                }
            }
            document.getElementById('ask-button').addEventListener('click', async () => {
                const userPrompt = document.getElementById('knowledge-points-input').value;
                if (!userPrompt.trim()) {
                    alert('è¯·è¾“å…¥é—®é¢˜ï¼');
                    return;
                }

                try {
                    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                    const loadingArea = document.createElement('div');
                    loadingArea.classList.add('loading-animation');
                    loadingArea.innerHTML = '<p>æ­£åœ¨ç”Ÿæˆå›ç­”... ğŸ”„</p>'; // å¯ä»¥ç”¨æ›´å¤æ‚çš„åŠ¨ç”»æ›¿æ¢
                    document.getElementById('knowledge-points-list').innerHTML = ''; // æ¸…ç©ºç»“æœ
                    document.getElementById('knowledge-points-list').appendChild(loadingArea);

                    const knowledgePoints = await pywebview.api.RAG_part(userPrompt);

                    // ç§»é™¤åŠ è½½åŠ¨ç”»
                    document.getElementById('knowledge-points-list').innerHTML = knowledgePoints;
                } catch (err) {
                    console.error('è·å–çŸ¥è¯†ç‚¹æ—¶å‡ºé”™:', err);
                }
            });


            async function fetchFolders() {
                const response = await fetch('/api/list-folders');
                const folders = await response.json();
                console.log('Fetched folders:', folders); // æ£€æŸ¥è¿”å›å€¼çš„ç»“æ„
                return folders.folders; // å‡è®¾åç«¯è¿”å›çš„æ˜¯ { folders: [...] }
            }

            // æ›´æ–°æ–‡ä»¶å¤¹åˆ—è¡¨
            async function updateFolderList() {
                const folderList = await fetchFolders();
                const folderContainer = document.getElementById('folder-list');
                folderContainer.innerHTML = '';

                folderList.forEach(folder => {
                    // åˆ›å»ºæ–‡ä»¶å¤¹é¡¹
                    const li = document.createElement('li');
                    li.classList.add('folder-item');
                    li.dataset.folderName = folder; // ä¿å­˜æ–‡ä»¶å¤¹åç§°
                    li.addEventListener('click', () => {
                        selectFolder(folder); // ç‚¹å‡»æ–‡ä»¶å¤¹æ—¶è°ƒç”¨å‡½æ•°
                    });

                    // æ–‡ä»¶å¤¹åç§°
                    const folderName = document.createElement('span');
                    folderName.textContent = folder;
                    li.appendChild(folderName);

                    // åˆ é™¤æŒ‰é’®
                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('folder-delete');
                    deleteButton.textContent = 'Ã—';
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘æ–‡ä»¶å¤¹ç‚¹å‡»äº‹ä»¶
                        deleteFolder(folder); // åˆ é™¤æ–‡ä»¶å¤¹
                    });
                    li.appendChild(deleteButton);

                    folderContainer.appendChild(li);
                });
            }

            // åˆ›å»ºæ–‡ä»¶å¤¹
            document.getElementById('create-folder').addEventListener('click', async () => {
                try {
                    // å¼¹å‡ºæç¤ºæ¡†ä¾›ç”¨æˆ·è¾“å…¥æ–‡ä»¶å¤¹åç§°
                    const folderName = prompt("è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹çš„åç§°:", "");
                    if (!folderName) {
                        console.log('æœªè¾“å…¥æ–‡ä»¶å¤¹åç§°');
                        return; // å¦‚æœç”¨æˆ·å–æ¶ˆè¾“å…¥æˆ–è€…æ²¡æœ‰è¾“å…¥å†…å®¹ï¼Œåˆ™è¿”å›
                    }

                    // å‘é€è¯·æ±‚åˆ°Flask API
                    const response = await fetch('/api/create-folder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ folderName })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ: ' + result.message); // ä½¿ç”¨alertå¼¹å‡ºæ¶ˆæ¯æ¡†
                        console.log('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ:', result.message);
                    } else {
                        alert('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ' + result.message); // ä½¿ç”¨alertå¼¹å‡ºé”™è¯¯æ¶ˆæ¯æ¡†
                        console.error('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥:', result.message);
                    }
                } catch (err) {
                    alert('åˆ›å»ºæ–‡ä»¶å¤¹æ—¶å‡ºé”™: ' + err.message); // ä½¿ç”¨alertå¼¹å‡ºé”™è¯¯æ¶ˆæ¯æ¡†
                    console.error('åˆ›å»ºæ–‡ä»¶å¤¹æ—¶å‡ºé”™:', err);
                }
                updateFolderList();
            });
            // åˆ é™¤æ–‡ä»¶å¤¹
            async function deleteFolder(folderName) {
                try {
                    const confirmation = confirm(`Are you sure you want to delete "${folderName}"?`); // ç¡®è®¤åˆ é™¤
                    if (!confirmation) return;

                    // è°ƒç”¨åç«¯ API åˆ é™¤æ–‡ä»¶å¤¹
                    const response = await fetch('/api/delete-folder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ folderName })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Folder deleted successfully!'); // åˆ é™¤æˆåŠŸ
                        updateFolderList(); // åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨
                    } else {
                        alert('Failed to delete folder: ' + result.message); // åˆ é™¤å¤±è´¥
                    }
                } catch (err) {
                    alert('Delete folder failed: ' + err.message); // åˆ é™¤å¤±è´¥
                }
            }
            async function loadMDFile(filePath) {
                try {
                    const response = await pywebview.api.read_md_files(filePath);
                    console.log('filePath:', filePath);
                    console.log('response:', response);

                    // æå–æ–‡ä»¶å
                    const fileName = Object.keys(response)[0]; // è·å–ç¬¬ä¸€ä¸ªé”®ï¼ˆæ–‡ä»¶åï¼‰
                    const mdContent = response[fileName]; // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºé”®è·å–å†…å®¹

                    console.log('fileName:', fileName);
                    console.log('mdContent:', mdContent);

                    if (!mdContent) {
                        throw new Error('No content found for the file');
                    }

                    const htmlContent = marked(mdContent);

                    document.querySelector('.content-display').style.display = 'block';
                    document.querySelector('.knowledge-points-section').style.display = 'block';
                    document.getElementById('return-button').style.display = 'block';
                    document.getElementById('video-upload-area').style.display = 'none';
                    document.getElementById('progress-bar').style.display = 'none';
                    document.getElementById('save-md').style.display = 'block';
                    document.getElementById('markdown-output').innerHTML = htmlContent;
                } catch (err) {
                    alert('è¯»å– Markdown æ–‡ä»¶æ—¶å‡ºé”™: ' + err.message);
                }
            }
            // åœ¨ selectFolder å‡½æ•°ä¸­åŠ¨æ€ç”Ÿæˆ MD æ–‡ä»¶åˆ—è¡¨
            async function selectFolder(folderName) {
                // è·å–æ‰€æœ‰æ–‡ä»¶å¤¹é¡¹
                const folderItems = document.querySelectorAll('.folder-item');
                
                // ç§»é™¤æ‰€æœ‰æ–‡ä»¶å¤¹é¡¹çš„ "folder-selected" ç±»
                folderItems.forEach(item => item.classList.remove('folder-selected'));

                // è·å–å½“å‰ç‚¹å‡»çš„æ–‡ä»¶å¤¹é¡¹
                const clickedFolder = document.querySelector(`.folder-item[data-folder-name="${folderName}"]`);
                
                // å¦‚æœå½“å‰æ–‡ä»¶å¤¹å·²å±•å¼€ï¼Œåˆ™æ”¶èµ·
                if (currentFolder === folderName) {
                    // æ”¶èµ·æ–‡ä»¶å¤¹ï¼Œéšè—å†…å®¹
                    clickedFolder.classList.remove('folder-selected');
                    currentFolder = '';
                    currentFiles = [];
                    currentFileIndex = -1;
                    document.querySelector('.content-display').style.display = 'none';
                    document.querySelector('.knowledge-points-section').style.display = 'none';
                    document.getElementById('return-button').style.display = 'none';
                    document.getElementById('video-upload-area').style.display = 'block';
                    document.getElementById('progress-bar').style.display = 'block';
                    document.getElementById('video-upload').value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    // æ¸…ç©ºè¿›åº¦æ¡
                    updateProgressBar(0);
                    document.getElementById('save-md').style.display = 'none';

                    // æ¸…é™¤ä¹‹å‰ç”Ÿæˆçš„ MD æ–‡ä»¶åˆ—è¡¨
                    const previousMDLists = document.querySelectorAll('.md-list');
                    previousMDLists.forEach(list => list.remove());
                } else {
                    // å±•å¼€æ–‡ä»¶å¤¹ï¼Œæ˜¾ç¤ºå†…å®¹
                    clickedFolder.classList.add('folder-selected');
                    
                    // æ¸…é™¤ä¹‹å‰ç”Ÿæˆçš„ MD æ–‡ä»¶åˆ—è¡¨
                    const previousMDLists = document.querySelectorAll('.md-list');
                    previousMDLists.forEach(list => list.remove());

                    // æ›´æ–°å½“å‰æ–‡ä»¶å¤¹
                    currentFolder = folderName;

                    try {
                        // è°ƒç”¨åç«¯ API è·å–æ–‡ä»¶å¤¹ä¸­çš„ MD æ–‡ä»¶åˆ—è¡¨
                        const response = await fetch(`/api/list-folders`);
                        const result = await response.json();
                        const mdFiles = result.files[currentFolder] || [];

                        console.log('MD Files:', mdFiles);

                        // åŠ¨æ€ç”Ÿæˆ MD æ–‡ä»¶åˆ—è¡¨
                        const mdListContainer = document.createElement('div');
                        mdListContainer.classList.add('md-list'); // æ·»åŠ ç±»åä»¥ä¾¿åç»­æ¸…é™¤

                        mdFiles.forEach(file => {
                            const mdItem = document.createElement('li');
                            mdItem.classList.add('md-item');
                            mdItem.textContent = file;

                            // åˆ é™¤æŒ‰é’®
                            const deleteButton = document.createElement('button');
                            deleteButton.classList.add('file-delete');
                            deleteButton.textContent = 'Ã—';
                            deleteButton.addEventListener('click', (e) => {
                                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                                deleteFile(folderName, file); // åˆ é™¤æ–‡ä»¶
                            });
                            mdItem.appendChild(deleteButton);

                            mdItem.addEventListener('click', () => {
                                const filePath = `${'./final_output'}/${currentFolder}/${file}`;
                                loadMDFile(filePath);
                            });

                            mdListContainer.appendChild(mdItem);
                        });

                        const folderContainer = document.getElementById('folder-list');
                        folderContainer.insertBefore(mdListContainer, clickedFolder.nextSibling);
                    } catch (err) {
                        console.error('Error selecting folder: ' + err.message);
                    }
                }
            }

            async function deleteFile(folderName, fileName) {
                try {
                    const confirmation = confirm(`Are you sure you want to delete "${fileName}"?`); // ç¡®è®¤åˆ é™¤
                    if (!confirmation) return;

                    // è°ƒç”¨åç«¯ API åˆ é™¤æ–‡ä»¶
                    const response = await fetch('/api/delete-file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ folderName, fileName })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('File deleted successfully!'); // åˆ é™¤æˆåŠŸ
                        updateFolderList(); // åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨
                    } else {
                        alert('Failed to delete file: ' + result.message); // åˆ é™¤å¤±è´¥
                    }
                } catch (err) {
                    alert('Delete file failed: ' + err.message); // åˆ é™¤å¤±è´¥
                }
            }

            document.getElementById('save-md').addEventListener('click', async () => {
                try {
                    // è·å–æ•´ä¸ªHTMLå†…å®¹ï¼ŒåŒ…æ‹¬å›¾ç‰‡
                    const htmlContent = document.getElementById('markdown-output').innerHTML;

                    // ä½¿ç”¨DOMParseræ¥è§£æå­—ç¬¦ä¸²ä¸ºDOMå¯¹è±¡ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥æ“ä½œ
                    let parser = new DOMParser();
                    let doc = parser.parseFromString(htmlContent, 'text/html');
                    
                    // æ·»åŠ å›¾ç‰‡åµŒå…¥åŠŸèƒ½
                    const images = Array.from(doc.querySelectorAll('img'));
                    await Promise.all(images.map(img => new Promise((resolve, reject) => {
                        const imageUrl = img.src;
                        fetch(imageUrl)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Failed to fetch image ${imageUrl}: ${response.statusText}`);
                                }
                                return response.blob();
                            })
                            .then(blob => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    const base64Data = reader.result.split(',')[1];
                                    const markdownImgSyntax = `[${img.alt}](data:${blob.type};base64,${base64Data})`;
                                    img.replaceWith(document.createTextNode(markdownImgSyntax));
                                    resolve(); // å›¾ç‰‡å¤„ç†å®Œæ¯•ï¼Œè§£å†³Promise
                                };
                                reader.readAsDataURL(blob);
                            })
                            .catch(error => {
                                console.error(`Error processing image ${imageUrl}:`, error);
                                reject(error); // å¤„ç†é”™è¯¯
                            });
                    })));

                    // ç§»é™¤å‰©ä½™çš„æ‰€æœ‰HTMLæ ‡ç­¾ï¼Œä»…ä¿ç•™æ–‡æœ¬å’Œå·²è½¬æ¢çš„Markdownå›¾ç‰‡è¯­æ³•
                    const finalMdContent = doc.body.textContent || doc.body.innerText;

                    // è·å–å½“å‰é€‰ä¸­çš„ç›®å½•å’Œæ–‡ä»¶å
                    const folderName = currentFolder; // ç¡®ä¿currentFolderå˜é‡å·²ç»å®šä¹‰
                    const fileName = prompt("è¯·è¾“å…¥æ–‡ä»¶åç§°:", "");

                    if (!folderName || !fileName) {
                        alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°å’Œæ–‡ä»¶åç§°');
                        return;
                    }

                    // è°ƒç”¨åç«¯APIä¿å­˜Markdownæ–‡ä»¶
                    const response = await fetch('/api/save-md', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mdContent: finalMdContent,
                            folderName: folderName,
                            fileName: fileName.replace(/\s+/g, '_') // æ›¿æ¢ç©ºæ ¼ä¸ºä¸‹åˆ’çº¿
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert('æ–‡ä»¶ä¿å­˜æˆåŠŸï¼');
                    } else {
                        alert('æ–‡ä»¶ä¿å­˜å¤±è´¥:' + result.message);
                    }
                } catch (err) {
                    alert('æ–‡ä»¶ä¿å­˜æ—¶å‡ºé”™:' + err.message);
                }
            });
            // è¿”å›æŒ‰é’®åŠŸèƒ½
            document.getElementById('return-button').addEventListener('click', () => {
                document.querySelector('.content-display').style.display = 'none';
                document.querySelector('.knowledge-points-section').style.display = 'none';
                document.getElementById('return-button').style.display = 'none';
                document.getElementById('video-upload-area').style.display = 'block';
                document.getElementById('progress-bar').style.display = 'block';
                document.getElementById('video-upload').value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                // æ¸…ç©ºè¿›åº¦æ¡
                updateProgressBar(0)
                document.getElementById('save-md').style.display = 'none';
                const clickedFolder = document.querySelector(`.folder-item`);
                clickedFolder.classList.remove('folder-selected');
                document.querySelectorAll('.md-list').forEach(list => list.remove());
                currentFolder = '';
            });
        })
        .catch(error => console.error('æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶:', error));
});
</script>
</body>
</html>